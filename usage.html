<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Advanced usage" href="advanced.html" /><link rel="prev" title="AWS IoT Core Credential Provider Session Helper" href="index.html" />

    <!-- Generated with Sphinx 7.1.2 and Furo 2024.05.06 -->
        <title>Usage - AWS IoT Core Credential Provider Session Helper documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=387cc868" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" /
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">AWS IoT Core Credential Provider Session Helper  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">AWS IoT Core Credential Provider Session Helper  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="codeofconduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev_notes.html">Development Notes</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/awslabs/aws-iot-core-credential-provider-session-helper/releases">Changelog</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="_sources/usage.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h1>
<p>This section covers the most common usage patterns for the helper, plus details on all the parameters that can be passed to build a Boto3 session object. It also covers less common uses such as PKCS#11 or the use of credentials from environment variables.</p>
<section id="general-usage">
<h2>General usage<a class="headerlink" href="#general-usage" title="Permalink to this heading">¶</a></h2>
<p>The most common use of the helper is through the use of local credentials stored on disk. This is the least recommended approach unless the private key file is properly protected from accidental or malicious use. For the example below, the credentials are stored in <code class="docutils literal notranslate"><span class="pre">/home/iotuser/.credentials</span></code>, and the application code has access to them.</p>
<p>This walks through the steps to create and use the helper.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Shorten the name of the session helper class</span>
<span class="kn">from</span> <span class="nn">awscrt.io</span> <span class="kn">import</span> <span class="n">LogLevel</span>
<span class="kn">from</span> <span class="nn">awsiot_credentialhelper.boto3_session</span> <span class="kn">import</span> <span class="n">Boto3SessionProvider</span>

<span class="c1"># 2. Create boto3 session object, endpoint name must match the AWS accounts unique</span>
<span class="c1">#    credential provider endpoint if using certificates registered without a</span>
<span class="c1">#    certificate authority. The get_session can also be passed a specific region other</span>
<span class="c1">#    than the region where credentials are obtained.</span>
<span class="n">boto3_session</span> <span class="o">=</span> <span class="n">Boto3SessionProvider</span><span class="p">(</span>
    <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;your_endpoint.credentials.iot.us-west-2.amazonaws.com&quot;</span><span class="p">,</span>
    <span class="n">role_alias</span><span class="o">=</span><span class="s2">&quot;your_aws_iot_role_alias_name&quot;</span><span class="p">,</span>
    <span class="n">certificate</span><span class="o">=</span><span class="s2">&quot;/home/iotuser/.credentials/iot_thing.pem&quot;</span><span class="p">,</span>
    <span class="n">private_key</span><span class="o">=</span><span class="s2">&quot;/home/iotuser/.credentials/iot_thing.pem.key&quot;</span><span class="p">,</span>
    <span class="n">thing_name</span><span class="o">=</span><span class="s2">&quot;iot_thing&quot;</span><span class="p">,</span>
    <span class="c1"># The rest are optional parameters, normally reserved for testing.</span>
    <span class="c1"># This CA is used to verify the credential provider endpoint&#39;s server certificate.</span>
    <span class="n">ca</span><span class="o">=</span><span class="s2">&quot;/opt/certs/AmazonCA1.pem&quot;</span><span class="p">,</span>
    <span class="c1"># Enable logging for the awscrt package, from NoLogs to Trace.</span>
    <span class="n">awscrt_log_level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">Debug</span><span class="p">,</span>
    <span class="c1"># When set to False removes the verification of the server certificate name to the endpoint</span>
    <span class="n">verify_peer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="s2">&quot;us-east-1&quot;</span><span class="p">)</span>

<span class="c1"># 3. With the session created, the helper will automatically request, cache, and refresh AWS credentials</span>
<span class="c1">#    based on the duration set with the IoT Role Alias (15 minutes to 12 hours).</span>

<span class="c1"># Creation of a client object doesn&#39;t make a network call to requests credentials</span>
<span class="n">iot</span> <span class="o">=</span> <span class="n">boto3_session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;iot&quot;</span><span class="p">)</span>

<span class="c1"># The first actual API call return credentials, cache them, and use the for all subsequent calls until</span>
<span class="c1"># the near expiration, at which time the helper will automatically refresh them.</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">iot</span><span class="o">.</span><span class="n">list_things</span><span class="p">()</span>
<span class="o">...</span>
<span class="c1"># 5 minutes pass. This next call uses the same credentials</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">iot_list_things</span><span class="p">()</span>
<span class="o">...</span>
<span class="c1"># 14 hours pass. This call will see the credentials have expired, so before the call the helper</span>
<span class="c1"># will request and cache new credentials</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">iot_list_things</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="credentials-as-environment-variables">
<h2>Credentials as environment variables<a class="headerlink" href="#credentials-as-environment-variables" title="Permalink to this heading">¶</a></h2>
<p>In certain situations, it may be more suitable provide the application credentials as variable and not give the application direct access to the credentials on disk. An example of this may be Python code running within in isolated environment such as a container.</p>
<p>By passing the certificate and private key as <code class="docutils literal notranslate"><span class="pre">bytes</span></code>, the helper will work as expected. Assume that the credentials are available as <code class="docutils literal notranslate"><span class="pre">CERTIFICATE_PEM</span></code> and <code class="docutils literal notranslate"><span class="pre">PRIVATE_KEY_PEM</span></code> environment variables. The values are read, encoded into <a class="reference external" href="https://en.wikipedia.org/wiki/UTF-8">UTF-8</a>, and then encoded as <code class="docutils literal notranslate"><span class="pre">bytes</span></code>. These will be used in the same manner as reading the certificate or private key from disk.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">awsiot_credentialhelper.boto3_session</span> <span class="kn">import</span> <span class="n">Boto3SessionProvider</span>

<span class="n">boto3_session</span> <span class="o">=</span> <span class="n">Boto3SessionProvider</span><span class="p">(</span>
    <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;your_endpoint.credentials.iot.us-west-2.amazonaws.com&quot;</span><span class="p">,</span>
    <span class="n">role_alias</span><span class="o">=</span><span class="s2">&quot;your_aws_iot_role_alias_name&quot;</span><span class="p">,</span>
    <span class="n">certificate</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CERTIFICATE_PEM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)),</span>
    <span class="n">private_key</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PRIVATE_KEY_PEM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)),</span>
    <span class="n">thing_name</span><span class="o">=</span><span class="s2">&quot;iot_thing&quot;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
</pre></div>
</div>
<p>These can also be mixed. For instance the certificate can be passed as file and the private key as a byte array:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">boto3_session</span> <span class="o">=</span> <span class="n">Boto3SessionProvider</span><span class="p">(</span>
    <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;your_endpoint.credentials.iot.us-west-2.amazonaws.com&quot;</span><span class="p">,</span>
    <span class="n">role_alias</span><span class="o">=</span><span class="s2">&quot;your_aws_iot_role_alias_name&quot;</span><span class="p">,</span>
    <span class="n">certificate</span><span class="o">=</span><span class="s2">&quot;/home/iotuser/.credentials/iot_thing.pem&quot;</span><span class="p">,</span>
    <span class="n">private_key</span><span class="o">=</span><span class="nb">bytes</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PRIVATE_KEY_PEM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)),</span>
    <span class="n">thing_name</span><span class="o">=</span><span class="s2">&quot;iot_thing&quot;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
</pre></div>
</div>
<p>To use this with containers, the values can be read and passed by the orchestrator (e.g., AWS IoT Greengrass, Kubernetes) as part of a <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code> command like this:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">CERTIFICATE_PEM</span><span class="o">=</span><span class="s2">&quot;some string&quot;</span><span class="w"> </span><span class="nv">PRIVATE_KEY_PEM</span><span class="o">=</span><span class="s2">&quot;some string&quot;</span><span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>-rm<span class="w"> </span>image_name<span class="w"> </span>...
</pre></div>
</div>
<p>The provided <code class="docutils literal notranslate"><span class="pre">CERTIFICATE_PEM</span></code> and <code class="docutils literal notranslate"><span class="pre">PRIVATE_KEY_PEM</span></code> will be accessible as environment variables within the running container’s context.</p>
</section>
<section id="using-pkcs-11-with-the-helper">
<h2>Using PKCS#11 with the helper<a class="headerlink" href="#using-pkcs-11-with-the-helper" title="Permalink to this heading">¶</a></h2>
<p>By using the awscrt package, the helper can also be used where it has <em>no</em> access to the private key except through a hardware security module (HSM). By offloading all crypto operations (encryption and decryption) to the HSM, this reduces the attack surface in obtaining the private key.</p>
<p>However, there are some caveats:</p>
<ul class="simple">
<li><p>The PKCS#11 interface is only available on Unix (Linux) operating systems–it is not available for Windows or macOS.</p></li>
<li><p>You are responsible for obtaining the library to interface with the specific HSM from the vendor.</p></li>
<li><p>The X.509 certificate must be present on disk (or as a variable–see above), and cannot be referenced from with the HSM.</p></li>
</ul>
<p>Instead of provide the <code class="docutils literal notranslate"><span class="pre">private_key</span></code> parameter, a <code class="docutils literal notranslate"><span class="pre">pkcs11</span></code> configuration is provided. The example below expects the private key to be located in slot 1 <em>or</em> have the defined <code class="docutils literal notranslate"><span class="pre">token_label</span></code>, and the private key is labeled with <code class="docutils literal notranslate"><span class="pre">test_key</span></code>. The <code class="docutils literal notranslate"><span class="pre">user_pin</span></code> is used to access the HSM. The steps to evaluate the private key are complex, please see the <a class="reference external" href="https://awslabs.github.io/aws-crt-python/api/io.html#awscrt.io.TlsContextOptions.create_client_with_mtls_pkcs11">awscrt io documentation</a> for more details.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">awsiot_credentialhelper.boto3_session</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Boto3SessionProvider</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">awsiot_credentialhelper.boto3_session</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Pkcs11Config</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">boto3_session</span> <span class="o">=</span> <span class="n">Boto3SessionProvider</span><span class="p">(</span>
    <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;your_endpoint.credentials.iot.us-west-2.amazonaws.com&quot;</span><span class="p">,</span>
    <span class="n">role_alias</span><span class="o">=</span><span class="s2">&quot;your_aws_iot_role_alias_name&quot;</span><span class="p">,</span>
    <span class="n">certificate</span><span class="o">=</span><span class="s2">&quot;/home/iotuser/.credentials/iot_thing.pem&quot;</span><span class="p">,</span>
    <span class="n">thing_name</span><span class="o">=</span><span class="s2">&quot;iot_thing&quot;</span><span class="p">,</span>
    <span class="n">pkcs11</span><span class="o">=</span><span class="n">Pkcs11Config</span><span class="p">(</span>
        <span class="n">pkcs11_lib</span><span class="o">=</span><span class="s2">&quot;/path/to/vendor/provided/module/pkcs11_module.so&quot;</span><span class="p">,</span>
        <span class="n">user_pin</span><span class="o">=</span><span class="s2">&quot;1234&quot;</span><span class="p">,</span>
        <span class="n">slot_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">token_label</span><span class="o">=</span><span class="s2">&quot;my_token_label&quot;</span><span class="p">,</span>
        <span class="n">private_key_label</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
</pre></div>
</div>
<p>After this, the <code class="docutils literal notranslate"><span class="pre">boto3_session</span></code> object can used as in the previous examples.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="advanced.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Advanced usage</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Home</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; Copyright Amazon.com Inc. or its affiliates.
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Usage</a><ul>
<li><a class="reference internal" href="#general-usage">General usage</a></li>
<li><a class="reference internal" href="#credentials-as-environment-variables">Credentials as environment variables</a></li>
<li><a class="reference internal" href="#using-pkcs-11-with-the-helper">Using PKCS#11 with the helper</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=b3ba4146"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="_static/scripts/furo.js?v=4e2eecee"></script>
    </body>
</html>